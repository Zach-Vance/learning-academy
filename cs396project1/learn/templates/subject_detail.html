{% extends 'base.html' %}

{% block content %}
<head>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<style>
   
    .section-card {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); 
        margin-bottom: 2rem; 
    }
    .section-card-header {
        background-color: #ddf7ddfa; 
        font-size: 1.5rem; 
    }
    .section-card-body {
        padding: 1.5rem;
    }
    .table th, .table td {
        vertical-align: middle; 
    }
    #semesterScoreChart {
        width: 800px; /* Adjust as needed */
        height: 400px; /* Adjust as needed */
    }
</style>

{% if user.is_authenticated %}
<h2 class="mt-4 text-center mb-5">{{ subject.name }}</h2>
<hr/>
{%if user.is_student %}
<div class="section-card">
    <div class="section-card-header">Available Quizzes</div>
    <div class="section-card-body">
        <!-- Quizzes Table -->
        <table class="table">
            <thead>
                <tr>
                    <th>Quiz</th>
                    <th>Length</th>
                    <th>Number of Attempts</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for quiz in quizzes %}
                    <tr>
                        <td>{{ quiz.name }}</td>
                        <td>{{ quiz.questions_count }} questions</td>
                        <td>{{ quiz.num_attempts }}</td>
                        <td><a href="{% url 'take_quiz' quiz.id %}" class="btn btn-primary">Start quiz</a></td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="4" class="text-center font-italic">There are no quizzes for this subject.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
<hr/>
<div class="section-card">
    <div class="section-card-header">Taken Quizzes</div>
    <div class="section-card-body">
        <h6>Average Quiz Score: {{ average_quiz_score|floatformat:2 }}% ({{ student_avg_percentile|floatformat:2 }}th percentile)</h6>
        <!-- Taken Quizzes Table -->
        <table class="table">
            <thead>
                <tr>
                    <th>Quiz</th>
                    <th>Attempt</th>
                    <th>Score</th>
                    <th>Percentile</th>
                </tr>
            </thead>
            <tbody>
                {% for taken_quiz in taken_quizzes %}
                    <tr>
                        <td><a href="{% url 'view_attempt' taken_quiz.id %}">{{ taken_quiz.quiz.name }}</a></td>
                        <td>{{ taken_quiz.attempt_number }}</td>
                        <td>{{ taken_quiz.score }}</td>
                        <td>{{ taken_quiz.percentile|floatformat:2 }}th percentile</td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="3" class="text-center font-italic">You haven't taken any quizzes for this subject yet.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
<hr/>
{% else %}

<div class="section-card">
    <div class="section-card-header">
        Score Statistics
    </div>
    <div class="section-card-body">
        <div class="row">
            <div class="col-md-4">
                <strong>Highest Score:</strong> {{ highest_score|floatformat:2  }}%
            </div>
            <div class="col-md-4">
                <strong>Lowest Score:</strong> {{ lowest_score|floatformat:2  }}%
            </div>
            <div class="col-md-4">
                <strong>Average Score:</strong> {{ average_score|floatformat:2 }}%
            </div>
        </div>
    </div>
</div>


<div class="section-card">
    <div class="section-card-header">{{ subject.name }} Grades By Semester</div>
    <div style="max-width: 600px; margin: auto;">
        <canvas id="semesterScoreChart"></canvas>
    </div>
    <script>
        var subjectName = "{{ subject.name|escapejs }}";
        var semesterDates = JSON.parse('{{ semester_dates_json|safe }}');
        var semesterScores = JSON.parse('{{ semester_scores_json|safe }}');

        document.addEventListener('DOMContentLoaded', function() {
        try {
            var ctx = document.getElementById('semesterScoreChart').getContext('2d');
            var semesterScoreChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: semesterDates,
                    datasets: [{
                        label: 'Student Scores',
                        data: semesterScores,
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Average Score'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Semesters'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Student ' + subjectName + ' Scores for Past 5 Semesters',
                            font: {
                                size: 18
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            enabled: true
                        }
                    }
                }
            });
        } catch (error) {
            console.error("Error initializing chart:", error);
        }
    });

    </script>
</div>


<div class="section-card-header d-flex justify-content-between align-items-center">
    <span>Student Scores</span>
    <div>
        <a href="?sort=asc" class="btn btn-sm {% if sort_order == 'asc' %}btn-success{% else %}btn-outline-success{% endif %}">Sort Ascending</a>
        <a href="?sort=desc" class="btn btn-sm {% if sort_order == 'desc' %}btn-success{% else %}btn-outline-success{% endif %}">Sort Descending</a>
    </div>
</div>
<br/>
<div class="float-right">
    <a href="{% url 'gradebook' subject.id %}" class="btn btn-primary">Go to Gradebook</a>
</div>
    <div class="section-card-body">
        <table class="table">
            <thead>
                <tr>
                    <th>Student</th>
                    <th>Average Score</th>
                </tr>
            </thead>
            <tbody>
                {% for student_average in student_averages %}
                    <tr>
                        <td>{{ student_average.student.user.get_full_name }}</td>
                        <td>{{ student_average.average_score|floatformat:2 }}%</td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="2" class="text-center font-italic">No quiz scores available.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>


    <div class="section-card">
        <div class="section-card-header">Quizzes</div>
        <div class="section-card-body">
            <form method="post" action="{% url 'update_quiz_weights' %}">
                {% csrf_token %}
                <table class="table">
                    <thead>
                        <tr>
                            <th>Quiz</th>
                            <th>Questions</th>
                            <th>Weights</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for quiz in quizzes %}
                            <tr>
                                <td>
                                    {% if quiz.is_owned_by_teacher %}
                                        <a href="{% url 'edit_quiz' quiz.pk %}">{{ quiz.name }}</a>
                                    {% else %}
                                        {{ quiz.name }}
                                    {% endif %}
                                </td>
                                
                                <td>{{ quiz.questions_count }}</td>
                                <td>
                                    <input type="number" name="weight_{{ quiz.pk }}" value="{{ quiz.weight }}" min="0" step="0.01">
                                </td>
                                <td class="text-right">
                                    {% if quiz.is_owned_by_teacher %}
                                        <a href="{% url 'quiz_results' quiz.pk %}" class="btn btn-primary">View Results</a>
                                    {% endif %}
                                </td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="3" class="text-center font-italic">There are no quizzes for this subject yet.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                    <button type="submit" class="btn btn-primary">Update Weights</button>
                </table>
        </form>
        </div>
    </div>


<hr/>
{% endif %}

<div class="section-card">
    <div class="section-card-header">Posts</div>
    <div class="section-card-body">
        <!-- Posts Table -->
        <table class="table">
        <thead>
            <tr>
                <th>Title</th>
                <th>Posted By</th>
                <th>Date</th>
            </tr>
        </thead>
        <tbody>
            {% for post in posts %}
                <tr>
                    <td><a href="{% url 'post' post.pk %}">{{ post.title }}</a></td>
                    <td>{{ post.author }} 
                        {% if post.author.is_student %}
                          (Student)
                        {% elif post.author.is_teacher %}
                          <i>(Teacher)</i>
                        {% else %}
                          <strong>(Admin)</strong>
                        {% endif %}
                      </td>
                    <td>{{ post.date }}</td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="4" class="text-center font-italic">There are no posts for this subject yet.</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
    <a href="{% url 'create_post' %}" class="btn btn-success">Add Post</a>
</div>
</div>
<hr/>
<div class="section-card">
<div class="section-card-header">Lessons</div>
<div class="section-card-body">
    <!-- Lessons Table -->
    <table class="table">
        <thead>
            <tr>
                <th>Title</th>
                <th>Author</th>
                <th>Date</th>
            </tr>
        </thead>
        <tbody>
            {% for lesson in lessons %}
                <tr>
                    <td><a href="{% url 'lesson' lesson.pk %}">{{ lesson.title }}</a></td>
                    <td>{{ lesson.author }}
                    {% if lesson.author.is_teacher %}
                      <i>(Teacher)</i>
                    {% else %}
                      <strong>(Admin)</strong>
                    {% endif %}

                    </td>
                    <td>{{ lesson.date }}</td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="3" class="text-center font-italic">There aren't any lessons</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
    {% if not user.is_student %} 
        </b><a href="{% url 'create_lesson' %}" class="btn btn-success">Add Lesson</a>
    {% endif %}
</div>
</div>
{% else %}
<div class="alert alert-warning mt-4" role="alert">
Please login to view this page.
</div>
{% endif %}
{% endblock %}

