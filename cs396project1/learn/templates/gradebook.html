{% extends 'base.html' %}

{% block content %}
<style>
   
    .section-card {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); 
        margin-bottom: 2rem; 
    }
    .section-card-header {
        background-color: #ddf7ddfa; 
        font-size: 1.5rem; 
    }
    .section-card-body {
        padding: 1.5rem;
    }
    .table th, .table td {
        vertical-align: middle; 
    }
    #semesterScoreChart {
        width: 800px; /* Adjust as needed */
        height: 400px; /* Adjust as needed */
    }
</style>
<h2 class="mt-4 text-center mb-5">{{ subject.name }} Gradebook</h2>
<hr/>
<div class="section-card">
    <div class="section-card-header">
        Score Statistics
    </div>
    <div class="section-card-body">
        <div class="row">
            <div class="col-md-4">
                <strong>Highest Score:</strong> {{ highest_score|floatformat:2 }}%
            </div>
            <div class="col-md-4">
                <strong>Lowest Score:</strong> {{ lowest_score|floatformat:2 }}%
            </div>
            <div class="col-md-4">
                <strong>Average Score:</strong> {{ average_score|floatformat:2 }}%
            </div>
        </div>
    </div>
</div>

<div class="section-card">
    <div class="section-card-header d-flex justify-content-between align-items-center">
        <span>Student Scores</span>
        <div>
            <a href="?sort=asc" class="btn btn-sm {% if sort_order == 'asc' %}btn-success{% else %}btn-outline-success{% endif %}">Sort Ascending</a>
            <a href="?sort=desc" class="btn btn-sm {% if sort_order == 'desc' %}btn-success{% else %}btn-outline-success{% endif %}">Sort Descending</a>
        </div>
    </div>
    
    <div class="clearfix"></div> 
    <div class="section-card-body">
        <table class="table">
            <thead>
                <tr>
                    <th>Student</th>
                    <th>Average Score</th>
                    <th>Letter Grade</th>
                </tr>
            </thead>
            <tbody>
                {% for student_average in student_averages %}
                    <tr>
                        <td>{{ student_average.student }}</td>
                        <td>{{ student_average.average_score|floatformat:2 }}%</td>
                        <td>{{ student_average.letter_grade }}</td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="3" class="text-center font-italic">No students found.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="section-card">
    <div class="section-card-header">{{ subject.name }} Grades By Semester</div>
    <div style="max-width: 600px; margin: auto;">
        <canvas id="semesterScoreChart"></canvas>
    </div>
    <script>
        var subjectName = "{{ subject.name|escapejs }}";
        var semesterDates = JSON.parse('{{ semester_dates_json|safe }}');
        var semesterScores = JSON.parse('{{ semester_scores_json|safe }}');

        document.addEventListener('DOMContentLoaded', function() {
            try {
                var ctx = document.getElementById('semesterScoreChart').getContext('2d');
                var semesterScoreChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: semesterDates,
                        datasets: [{
                            label: 'Student Scores',
                            data: semesterScores,
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }]
                    },
                    // ... [rest of the chart configuration] ...
                });
            } catch (error) {
                console.error("Error initializing chart:", error);
            }
        });
    </script>
</div>

{{ grade_distribution|json_script:"gradeDistribution" }}

<div class="section-card">
    <div class="section-card-header">
        Grade Distribution
    </div>
    <div class="section-card-body">
        <div style="max-width: 600px; margin: auto;">
            <canvas id="gradeDistributionChart"></canvas>
        </div>  
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                var gradeDistributionData = JSON.parse(document.getElementById('gradeDistribution').textContent);
                var ctx = document.getElementById('gradeDistributionChart').getContext('2d');
                var gradeDistributionChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(gradeDistributionData),
                        datasets: [{
                            data: Object.values(gradeDistributionData),
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.5)',
                                'rgba(54, 162, 235, 0.5)',
                                'rgba(255, 206, 86, 0.5)',
                                'rgba(75, 192, 192, 0.5)',
                                'rgba(153, 102, 255, 0.5)',
                                'rgba(255, 159, 64, 0.5)'
                            ],
                            borderColor: [
                                'rgba(255, 99, 132, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 206, 86, 1)',
                                'rgba(75, 192, 192, 1)',
                                'rgba(153, 102, 255, 1)',
                                'rgba(255, 159, 64, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            title: {
                                display: true,
                                text: 'Grade Distribution',
                                font: {
                                    size: 18
                                }
                            }
                        }
                    }
                });
            });
        </script>
              
    </div>
</div>

<div class="section-card">
    <div class="section-card-header">
        Edit Grade Scale
    </div>
    <div class="section-card-body">
        <form method="post">
            {% csrf_token %}
            {{ grade_scale_form.as_p }}
            <button type="submit" class="btn btn-primary">Update Grade Scale</button>
        </form>
    </div>
</div>

{% endblock %}


